<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registration</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="CSS/styles.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;200;300;400;500;600;700;800;900&display=swap">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="icon" href="Assets/logo.png" type="image/x-icon">
</head>
<body>
    <div class="top-section">
        <nav>
            <a href="index.html" class="navbar-left">
                <img src="Assets/logo.png" class="b3slogo" alt="B3S Logo">
                <div class="brand-name">
                    <span class="brand-title">DriveHub</span>
                </div>
            </a>
        </nav>
    </div>
    <main class="d-flex align-items-center">
        <div class="progress-container">
            <div class="step active">
                <div class="bullet">1</div>
                <div class="title">Registration</div>
            </div>
            <div class="line"></div>
            <div class="step">
                <div class="bullet">2</div>
                <div class="title">Verification</div>
            </div>
            <div class="line"></div>
            <div class="step">
                <div class="bullet">3</div>
                <div class="title">Personal Information</div>
            </div>
        </div>
        <div class="container d-flex justify-content-center">
            <div class="card login-card">
                <div class="card-body">
                    <img src="Assets/logo.png" alt="Logo" class="login-logo"><br>
                    <form id="registerForm" class="login-form">
                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" placeholder="Email" required>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">Password</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="password" placeholder="Password" required>
                                <button class="btn btn-outline-white" type="button" id="togglePassword" aria-label="Toggle Password Visibility">
                                    <i class="fas fa-eye-slash"></i>
                                </button>
                            </div>
                        </div>
                        <div id="passwordRequirements">
                            <div class="requirement invalid" id="minLength">
                                <i class="fas fa-times"></i><p>Must be a minimum of 8 characters.</p>
                            </div>
                            <div class="requirement invalid" id="letters">
                                <i class="fas fa-times"></i><p>Must contain at least 1 upper case and lower case letter.</p>
                            </div>
                            <div class="requirement invalid" id="numbersSymbols">
                                <i class="fas fa-times"></i><p>Must contain numbers and symbols.</p>
                            </div>
                        </div>
                        <div class="d-flex justify-content-center">
                            <button type="submit" id="signUp" class="btn btn-outline-primary create-btn">CREATE ACCOUNT</button>
                        </div>
                        <p class="text-center mt-3">Already have an account? <a href="login.html" id="loginLink" class="text-dark">Login Here!</a></p>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <!-- Policy Privacy Modal -->
<div class="modal fade" id="privacyModal" tabindex="-1" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Privacy Policy</h5>
            </div>
            <form class="traits">
                <div class="modal-body">
                    <h4>Please read our privacy policy carefully.</h4>
                    <p>
                        DriveHub is committed to protecting your privacy. This Privacy Policy explains how we collect, use, disclose, and safeguard your information when you use our services, including our website and mobile application (collectively, the "Services"). By using our Services, you agree to the collection and use of information in accordance with this policy.
                    </p>
                    <h5>Information We Collect</h5>
                    <p>
                        We may collect and process the following types of information: 
                        <ul>
                            <li><strong>Personal Information:</strong> Name, email address, phone number, address, date of birth, and any other information you provide to us directly.</li>
                            <li><strong>Usage Data:</strong> Information about how you use our Services, including your IP address, browser type, pages visited, and time spent on the Services.</li>
                            <li><strong>Cookies and Tracking Technologies:</strong> We may use cookies and similar tracking technologies to monitor activity on our Services and store certain information.</li>
                        </ul>
                    </p>
                    <h5>How We Use Your Information</h5>
                    <p>
                        We use the information we collect for various purposes, including:
                        <ul>
                            <li>To provide, maintain, and improve our Services.</li>
                            <li>To process your bookings and manage your account.</li>
                            <li>To communicate with you, including sending you updates and promotional materials.</li>
                            <li>To monitor the usage of our Services.</li>
                            <li>To detect, prevent, and address technical issues.</li>
                            <li>To comply with legal obligations.</li>
                        </ul>
                    </p>
                    <h5>Your Rights</h5>
                    <p>
                        Depending on your location, you may have rights regarding your personal information. Please contact us for more information.
                    </p>
                    <div class="form-group">
                        <label class="custom-checkbox">
                            <input type="checkbox" id="agreeCheckbox" required>
                            <span class="checkbox-label">I agree to the Privacy Policy</span>
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-primary dec-btn" id="declineButton">Decline</button>
                    <button type="button" class="btn btn-outline-primary save-btn">Accept</button>
                </div>
            </form>
        </div>
    </div>
</div>

    <!-- Notification Modal -->
    <div class="modal fade" id="notificationModal" tabindex="-1" aria-labelledby="notificationModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="notificationModalLabel">Notification</h5>
                </div>
                <div class="modal-body" id="notificationMessage">
                    <!-- Notification message will be set dynamically -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="JS/reg.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
        import { getFirestore, doc, setDoc, query, collection, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
    
        document.addEventListener('DOMContentLoaded', () => {
            const firebaseConfig = {
                apiKey: "AIzaSyBflGD3TVFhlOeUBUPaX3uJTuB-KEgd0ow",
                authDomain: "authentication-d6496.firebaseapp.com",
                projectId: "authentication-d6496",
                storageBucket: "authentication-d6496.appspot.com",
                messagingSenderId: "195867894399",
                appId: "1:195867894399:web:596fb109d308aea8b6154a"
            };
    
            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            const firestore = getFirestore(app);
    
            const registerForm = document.getElementById('registerForm');
            const passwordInput = document.getElementById('password');
            const minLengthRequirement = document.getElementById('minLength');
            const lettersRequirement = document.getElementById('letters');
            const numbersSymbolsRequirement = document.getElementById('numbersSymbols');
            const togglePassword = document.getElementById('togglePassword');
    
            // Function to generate a unique temporary ID
            function generateTemporaryId() {
                return 'temp-' + Math.random().toString(36).substr(2, 9);
            }
    
            // Password Visibility Toggle
            togglePassword.addEventListener('click', () => {
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);
                togglePassword.querySelector('i').classList.toggle('fa-eye');
                togglePassword.querySelector('i').classList.toggle('fa-eye-slash');
            });
    
            // Password Input Validation
            passwordInput.addEventListener('input', () => {
                const password = passwordInput.value;
    
                // Validate Password Length
                if (password.length >= 8) {
                    minLengthRequirement.classList.remove('invalid');
                    minLengthRequirement.classList.add('valid');
                    minLengthRequirement.querySelector('i').className = 'fas fa-check';
                } else {
                    minLengthRequirement.classList.remove('valid');
                    minLengthRequirement.classList.add('invalid');
                    minLengthRequirement.querySelector('i').className = 'fas fa-times';
                }
    
                // Validate Password Characters
                const hasLowerCase = /[a-z]/.test(password);
                const hasUpperCase = /[A-Z]/.test(password);
    
                if (hasLowerCase && hasUpperCase) {
                    lettersRequirement.classList.remove('invalid');
                    lettersRequirement.classList.add('valid');
                    lettersRequirement.querySelector('i').className = 'fas fa-check';
                } else {
                    lettersRequirement.classList.remove('valid');
                    lettersRequirement.classList.add('invalid');
                    lettersRequirement.querySelector('i').className = 'fas fa-times';
                }
    
                // Validate Password Numbers and Symbols
                const hasNumbers = /\d/.test(password);
                const hasSymbols = /[@$!%*?&]/.test(password);
    
                if (hasNumbers && hasSymbols) {
                    numbersSymbolsRequirement.classList.remove('invalid');
                    numbersSymbolsRequirement.classList.add('valid');
                    numbersSymbolsRequirement.querySelector('i').className = 'fas fa-check';
                } else {
                    numbersSymbolsRequirement.classList.remove('valid');
                    numbersSymbolsRequirement.classList.add('invalid');
                    numbersSymbolsRequirement.querySelector('i').className = 'fas fa-times';
                }
            });
    
            // Form Submission
            registerForm.addEventListener('submit', async (event) => {
                event.preventDefault(); // Prevent the default form submission
    
                const email = document.getElementById('email').value.trim();
                const password = document.getElementById('password').value;
    
                // Validate Email
                if (!validateEmail(email)) {
                    showErrorMessage('emailError', 'Please Enter a valid email address.');
                    return;
                }
    
                // Check for duplicate email
                const emailExists = await checkEmailExists(email);
                if (emailExists) {
                    showErrorMessage('emailError', 'This email is already registered.');
                    return;
                }
    
                // Ensure all password requirements are met
                if (document.querySelectorAll('.requirement.invalid').length > 0) {
                    showErrorMessage('passwordError', 'Please make sure your password meets all requirements.');
                    return;
                }
    
                try {
                    // Generate a unique temporary ID
                    const tempDocId = generateTemporaryId();
    
                    // Hash the password using SHA-256
                    const hashedPassword = CryptoJS.SHA256(password).toString();
    
                    // Create a document in Firestore to temporarily store the registration info
                    const tempDocRef = doc(firestore, "temporaryRegistrations", tempDocId);
                    await setDoc(tempDocRef, {
                        email: email,
                        password: hashedPassword, // Store the hashed password
                        registrationPhase: 1,
                        createdAt: new Date(),
                        expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000) // Expire in 24 hours
                    });
    
                    // Store necessary data in sessionStorage
                    sessionStorage.setItem('email', CryptoJS.AES.encrypt(email, 'your-secret-key').toString()); // Encrypt email
                    sessionStorage.setItem('password', CryptoJS.AES.encrypt(password, 'your-secret-key').toString()); // Encrypt the original password
                    sessionStorage.setItem('tempDocId', tempDocId); // Store the generated tempDocId
    
                    // Redirect to phone verification page
                    window.location.replace('numberinput.html');
                } catch (error) {
                    showErrorMessage('formError', 'Error saving temporary registration: ' + error.message);
                }
            });
    
            function validateEmail(email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email);
            }
    
            async function checkEmailExists(email) {
                const userQuery = query(collection(firestore, 'applicants'), where('email', '==', email));
                const querySnapshot = await getDocs(userQuery);
                return !querySnapshot.empty;
            }
    
            function showErrorMessage(elementId, message) {
                const notificationMessage = document.getElementById('notificationMessage');
                const notificationModal = new bootstrap.Modal(document.getElementById('notificationModal'));
            
                notificationMessage.textContent = message;
                notificationModal.show();
            }            
        });
    </script>
</body>
</html>
